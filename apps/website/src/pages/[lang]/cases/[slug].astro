---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import PWAEmbed from "../../../components/PWAEmbed.astro";
import CaseStudyController from "../../../components/CaseStudyController.tsx";
import ScrollReveal from "../../../components/ScrollReveal.astro";
import CaseProgress from "../../../components/CaseProgress.astro";
import StickyMobileCTA from "../../../components/StickyMobileCTA.astro";
import { ui } from "../../../i18n/ui";

// Step type with optional targetChart for highlight correlation
type ChartId = 'ichart' | 'boxplot' | 'pareto' | 'stats' | 'regression' | 'gagerr';

interface CaseStep {
	title: string;
	content: string;
	interactive: boolean;
	targetChart?: ChartId;
}

export function getStaticPaths() {
	const languages = Object.keys(ui);

	// Case study data - the 5 cases from the 12-week calendar
	const caseStudies = [
		{
			slug: "bottleneck",
			props: {
				week: 1,
				phase: 1,
				sampleKey: "bottleneck",
				title: "The Bottleneck",
				subtitle: "Finding the Hidden Constraint",
				description: "A process with 5 steps. Step 3 was blamed. But what did the data show?",
				problem: {
					lead: "Which step is actually the bottleneck?",
					context: "A manufacturing process had 5 sequential steps. Whenever delays occurred, Step 3 was blamed. The manager wanted to invest in new equipment for Step 3. But nobody had actually looked at the data...",
				},
				objectives: [
					"Use I-Chart to see variation over time",
					"Compare process steps with Boxplot",
					"Identify the step with the most variation",
				],
				steps: [
					{
						title: "Look at the Boxplot",
						content: "Notice how the boxes have different sizes. A wider box means more variation. Which step has the widest spread?",
						interactive: false,
						targetChart: "boxplot" as ChartId,
					},
					{
						title: "Check Step 2",
						content: "Step 2 has 3x the variation of the others. This is where the real constraint is hiding.",
						interactive: false,
						targetChart: "boxplot" as ChartId,
					},
					{
						title: "Click on Step 2",
						content: "Click the Step 2 box in the Boxplot. Watch how the I-Chart updates to show only Step 2's data. Now you can see the time pattern.",
						interactive: true,
						targetChart: "boxplot" as ChartId,
					},
					{
						title: "The Insight",
						content: "Step 3 wasn't the bottleneck. Step 2 was. The manager almost invested in the wrong equipment.",
						interactive: false,
						targetChart: "ichart" as ChartId,
					},
				],
				insight: "What's hiding in YOUR process?",
				nextCase: "hospital-ward",
			}
		},
		{
			slug: "hospital-ward",
			props: {
				week: 5,
				phase: 2,
				sampleKey: "hospital-ward",
				title: "Hospital Ward",
				subtitle: "The Aggregation Trap",
				description: "The dashboard showed 75% occupancy. Everything looked fine. But was it?",
				problem: {
					lead: "What is your daily average hiding?",
					context: "A hospital ward dashboard showed 75% average occupancy. Management was satisfied - plenty of capacity. But nurses complained about being overwhelmed. The numbers didn't match the reality...",
				},
				objectives: [
					"Understand how averages can hide patterns",
					"Use I-Chart to see hourly variation",
					"Identify time-based patterns",
				],
				steps: [
					{
						title: "The Average Looks Fine",
						content: "75% occupancy sounds reasonable. There's capacity to spare. But averages hide the story within.",
						interactive: false,
						targetChart: "stats" as ChartId,
					},
					{
						title: "Look at the Hourly Data",
						content: "The I-Chart shows occupancy by hour. Notice how it swings dramatically throughout the day.",
						interactive: false,
						targetChart: "ichart" as ChartId,
					},
					{
						title: "Filter by Time of Day",
						content: "Click on the high points in the I-Chart. You'll see: 95% at night (crisis), 50% in the afternoon (waste).",
						interactive: true,
						targetChart: "ichart" as ChartId,
					},
					{
						title: "The Hidden Pattern",
						content: "The 75% average hid two problems: night shift understaffing AND afternoon overcapacity. Different solutions for different times.",
						interactive: false,
						targetChart: "boxplot" as ChartId,
					},
				],
				insight: "Your dashboard average might be lying to you.",
				nextCase: "coffee",
			}
		},
		{
			slug: "coffee",
			props: {
				week: 9,
				phase: 3,
				sampleKey: "coffee",
				title: "Coffee Quality",
				subtitle: "East Africa Washing Station",
				description: "Drying Bed C consistently fails export spec. Is it the bed, the operator, or the measurement?",
				problem: {
					lead: "Which drying bed is causing the moisture problems?",
					context: "A coffee washing station in East Africa exports specialty coffee. Moisture content must be 10-12% for export. Bed C's batches keep failing. The manager blames the bed location. But is that the real cause?",
				},
				objectives: [
					"Compare factors using Boxplot",
					"Identify the outlier group",
					"Consider measurement system validity",
				],
				steps: [
					{
						title: "Compare the Drying Beds",
						content: "The Boxplot shows moisture by drying bed. Bed C has a higher median and more spread. But why?",
						interactive: false,
						targetChart: "boxplot" as ChartId,
					},
					{
						title: "Check for Patterns",
						content: "Click on Bed C to see its time pattern. Is it consistently high, or are there spikes?",
						interactive: true,
						targetChart: "boxplot" as ChartId,
					},
					{
						title: "The Operator Question",
						content: "Notice that Bed C is always measured by the same operator. Is it the bed, or is it how they measure?",
						interactive: false,
						targetChart: "ichart" as ChartId,
					},
					{
						title: "The MSA Connection",
						content: "Before blaming the bed, check the measurement system. A Gage R&R study reveals the moisture meter has ~8% variation - that's acceptable. The problem IS the bed.",
						interactive: false,
						targetChart: "gagerr" as ChartId,
					},
				],
				insight: "Before you blame the process, verify your measurement.",
				nextCase: "packaging",
			}
		},
		{
			slug: "packaging",
			props: {
				week: 9,
				phase: 3,
				sampleKey: "packaging",
				title: "Packaging Defects",
				subtitle: "Africa Manufacturing",
				description: "Night shift is systematically underfilling. Is it the operators, the equipment, or something else?",
				problem: {
					lead: "What's causing the fill weight problems on night shift?",
					context: "A packaging facility runs two shifts. The night shift has higher defect rates and more underfilling complaints. Management wants to retrain the night operators. But is training really the answer?",
				},
				objectives: [
					"Use Pareto to prioritize defect types",
					"Compare shifts using Boxplot",
					"Connect defects to process measurements",
				],
				steps: [
					{
						title: "Prioritize with Pareto",
						content: "The Pareto chart shows defect types. 'Underfill' dominates at 60%. Focus here first.",
						interactive: false,
						targetChart: "pareto" as ChartId,
					},
					{
						title: "Compare the Shifts",
						content: "The Boxplot by shift shows night shift has lower median fill weight. It's systematic, not random.",
						interactive: true,
						targetChart: "boxplot" as ChartId,
					},
					{
						title: "Check the Equipment",
						content: "Night shift uses the older filling machine. The I-Chart shows it drifts low over time.",
						interactive: false,
						targetChart: "ichart" as ChartId,
					},
					{
						title: "The Real Cause",
						content: "It's not the operators - it's the equipment. Retraining won't fix a machine that needs calibration.",
						interactive: false,
						targetChart: "stats" as ChartId,
					},
				],
				insight: "Don't blame people for equipment problems.",
				nextCase: "avocado",
			}
		},
		{
			slug: "avocado",
			props: {
				week: 12,
				phase: 3,
				sampleKey: "avocado",
				title: "Avocado Coating",
				subtitle: "Post-Harvest Optimization",
				description: "More coating means longer shelf life. But can operators apply it consistently?",
				problem: {
					lead: "What's the optimal coating level for maximum shelf life?",
					context: "A post-harvest facility coats avocados with wax to extend shelf life. Research suggests more coating = longer shelf life. But there's 28% unexplained variation in the results. Why?",
				},
				objectives: [
					"Understand regression relationships",
					"Interpret R-squared values",
					"Connect MSA to unexplained variation",
				],
				steps: [
					{
						title: "The Regression",
						content: "Coating amount explains 72% of shelf life variation (RÂ² = 0.72). Each ml/kg adds ~3 days.",
						interactive: false,
						targetChart: "regression" as ChartId,
					},
					{
						title: "But 28% is Unexplained",
						content: "What accounts for the remaining variation? Look at the residuals - some operators have systematic patterns.",
						interactive: true,
						targetChart: "regression" as ChartId,
					},
					{
						title: "The MSA Reveals",
						content: "A Gage R&R study shows operator reproducibility is ~22%. Joseph consistently under-applies by 20%.",
						interactive: false,
						targetChart: "gagerr" as ChartId,
					},
					{
						title: "The Business Decision",
						content: "Fix operator technique first, then re-run the regression. The coating formula might be fine when applied consistently.",
						interactive: false,
						targetChart: "stats" as ChartId,
					},
				],
				insight: "Before optimizing the formula, verify you can apply it consistently.",
				nextCase: null,
			}
		},
	];

	return languages.flatMap((lang) =>
		caseStudies.map((caseStudy) => ({
			params: { lang, slug: caseStudy.slug },
			props: caseStudy.props
		}))
	);
}

const {
	title,
	subtitle,
	description,
	sampleKey,
	problem,
	objectives,
	steps,
	insight,
	nextCase,
	week,
	phase
} = Astro.props;

const { lang } = Astro.params;
---

<BaseLayout title={`VaRiScout | ${title}`} description={description}>
	<!-- Progress indicator (desktop only) -->
	<CaseProgress currentCase={sampleKey} currentAct={1} lang={lang} />

	<!-- Sticky mobile CTA -->
	<StickyMobileCTA href="/app" text="Try Free" hideWhenVisible="cta-section" />

	<!-- Hero / Act 1: The Problem -->
	<section class="py-16 bg-white border-b border-neutral-200" id="problem-section">
		<div class="container-wide">
			<ScrollReveal animation="fade-up">
				<div class="max-w-3xl mb-8">
					<a href={`/${lang}/cases`} class="text-sm font-medium text-brand-primary mb-4 block">&larr; Case Studies</a>
					<div class="flex items-center gap-3 mb-4">
						<span class="text-xs font-medium px-2 py-1 bg-brand-primary/10 text-brand-primary rounded">
							Phase {phase} &middot; Week {week}
						</span>
					</div>
					<h1 class="text-4xl md:text-5xl font-bold mb-3">{title}</h1>
					<p class="text-xl text-neutral-500 mb-6">{subtitle}</p>
				</div>
			</ScrollReveal>

			<!-- Problem Statement Card -->
			<ScrollReveal animation="fade-up" delay={100}>
				<div class="max-w-3xl p-8 bg-neutral-50 border border-neutral-200 rounded-2xl mb-8">
					<h2 class="text-sm font-bold text-neutral-400 uppercase tracking-wider mb-4">The Problem</h2>
					<p class="text-2xl font-semibold mb-4">{problem.lead}</p>
					<p class="text-neutral-600 leading-relaxed">{problem.context}</p>
				</div>
			</ScrollReveal>

			<!-- Learning Objectives -->
			<ScrollReveal animation="fade-up" delay={200}>
				<div class="max-w-3xl">
					<h3 class="text-sm font-bold text-neutral-400 uppercase tracking-wider mb-4">What You'll Learn</h3>
					<ul class="space-y-2">
						{objectives.map((obj, i) => (
							<li class="flex items-start gap-3" style={`animation-delay: ${250 + i * 50}ms`}>
								<span class="shrink-0 w-5 h-5 rounded-full bg-brand-primary/10 text-brand-primary flex items-center justify-center text-xs">&#10003;</span>
								<span class="text-neutral-700">{obj}</span>
							</li>
						))}
					</ul>
				</div>
			</ScrollReveal>
		</div>
	</section>

	<!-- Act 2: Interactive Exploration -->
	<section class="py-12 bg-neutral-900 sticky top-0 z-40" id="interactive-section">
		<div class="container-wide">
			<div class="text-center mb-8">
				<h2 class="text-2xl font-bold text-white mb-2">Your Turn: Explore the Data</h2>
				<p class="text-neutral-400">Click the charts to filter and explore. Can you find the pattern?</p>
			</div>
			<PWAEmbed
				sampleKey={sampleKey}
				title={`${title} - Interactive Analysis`}
				height="650px"
				iframeId={`pwa-embed-${sampleKey}`}
			/>
		</div>
	</section>

	<!-- Act 3: Guided Solution -->
	<section class="py-16 bg-white" id="solution-section">
		<div class="container-wide">
			<div class="max-w-3xl mx-auto">
				<ScrollReveal animation="fade-in">
					<h2 class="text-2xl font-bold mb-8 text-center">The Solution Journey</h2>
				</ScrollReveal>

				<!-- CaseStudyController - React island with client:load for immediate hydration -->
				<CaseStudyController
					client:load
					iframeId={`pwa-embed-${sampleKey}`}
					steps={steps}
					defaultIntensity="pulse"
				/>

				<!-- Key Insight -->
				<ScrollReveal animation="scale" delay={200}>
					<div class="mt-12 p-8 bg-neutral-900 text-white rounded-2xl text-center">
						<p class="text-sm font-medium text-neutral-400 uppercase tracking-wider mb-3">The Key Insight</p>
						<p class="text-2xl font-bold">{insight}</p>
					</div>
				</ScrollReveal>
			</div>
		</div>
	</section>

	<!-- CTA Section -->
	<section class="py-16 bg-neutral-50 border-t border-neutral-200" id="cta-section">
		<div class="container-wide">
			<ScrollReveal animation="fade-up">
				<div class="max-w-3xl mx-auto text-center">
					<h2 class="text-3xl font-bold mb-4">What's hiding in YOUR data?</h2>
					<p class="text-neutral-600 mb-8">Try VaRiScout with your own data. Free, no signup required.</p>
					<div class="flex gap-4 justify-center flex-wrap">
						<a href="/app" class="btn btn-primary px-8 py-3">Try Free</a>
						{nextCase && (
							<a href={`/${lang}/cases/${nextCase}`} class="btn btn-secondary px-8 py-3">Next Case &rarr;</a>
						)}
					</div>
				</div>
			</ScrollReveal>
		</div>
	</section>
</BaseLayout>
