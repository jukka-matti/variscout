---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ScrollReveal from "../../../components/ScrollReveal.astro";
import CaseProgress from "../../../components/CaseProgress.astro";
import JourneyCaseBadge from "../../../components/JourneyCaseBadge.astro";
import StickyMobileCTA from "../../../components/StickyMobileCTA.astro";
import CaseMeta from "../../../components/CaseMeta.astro";
import RelatedTools from "../../../components/RelatedTools.astro";
import WhatsNext from "../../../components/WhatsNext.astro";
import { ui } from "../../../i18n/ui";
import { CASE_STUDIES } from "../../../data/casesData";

// React island components
import CaseStudyChartsIsland from "../../../components/islands/CaseStudyChartsIsland";
import CaseStepsDisplay from "../../../components/CaseStepsDisplay.tsx";

export function getStaticPaths() {
	const languages = Object.keys(ui);

	return languages.flatMap((lang) =>
		CASE_STUDIES.map((caseStudy) => ({
			params: { lang, slug: caseStudy.slug },
			props: caseStudy
		}))
	);
}

const {
	title,
	subtitle,
	description,
	sampleKey,
	problem,
	objectives,
	steps,
	insight,
	nextCase,
	week,
	phase,
	difficulty,
	time,
	tools,
} = Astro.props;

const { lang } = Astro.params;
---

<BaseLayout title={`VaRiScout | ${title}`} description={description}>
	<!-- Progress indicator (desktop only) -->
	<CaseProgress currentCase={sampleKey} currentAct={1} lang={lang} />

	<!-- Journey context badge -->
	<JourneyCaseBadge lang={lang} currentAct={1} />

	<!-- Sticky mobile CTA -->
	<StickyMobileCTA href="/app" text="Try Free" hideWhenVisible="cta-section" />

	<!-- Hero / Act 1: The Problem -->
	<section class="py-16 bg-white border-b border-neutral-200" id="problem-section">
		<div class="container-wide">
			<ScrollReveal animation="fade-up">
				<div class="max-w-3xl mb-8">
					<a href={`/${lang}/cases`} class="text-sm font-medium text-brand-primary mb-4 block">&larr; Case Studies</a>
					<div class="flex items-center gap-3 mb-4">
						<span class="text-xs font-medium px-2 py-1 bg-brand-primary/10 text-brand-primary rounded">
							Phase {phase} &middot; Week {week}
						</span>
					</div>
					<h1 class="text-4xl md:text-5xl font-bold mb-3">{title}</h1>
					<p class="text-xl text-neutral-500 mb-4">{subtitle}</p>
					<CaseMeta difficulty={difficulty} time={time} />
				</div>
			</ScrollReveal>

			<!-- Problem Statement Card -->
			<ScrollReveal animation="fade-up" delay={100}>
				<div class="max-w-3xl p-8 bg-neutral-50 border border-neutral-200 rounded-2xl mb-8">
					<h2 class="text-sm font-bold text-neutral-400 uppercase tracking-wider mb-4">Act 1: The Problem</h2>
					<p class="text-2xl font-semibold mb-4">{problem.lead}</p>
					<p class="text-neutral-600 leading-relaxed">{problem.context}</p>
				</div>
			</ScrollReveal>

			<!-- Learning Objectives -->
			<ScrollReveal animation="fade-up" delay={200}>
				<div class="max-w-3xl">
					<h3 class="text-sm font-bold text-neutral-400 uppercase tracking-wider mb-4">What You'll Learn</h3>
					<ul class="space-y-2">
						{objectives.map((obj, i) => (
							<li class="flex items-start gap-3" style={`animation-delay: ${250 + i * 50}ms`}>
								<span class="shrink-0 w-5 h-5 rounded-full bg-brand-primary/10 text-brand-primary flex items-center justify-center text-xs">&#10003;</span>
								<span class="text-neutral-700">{obj}</span>
							</li>
						))}
					</ul>
				</div>
			</ScrollReveal>
		</div>
	</section>

	<!-- Act 2: Interactive Exploration -->
	<section class="py-12 bg-neutral-900 sticky top-0 z-40" id="interactive-section">
		<div class="container-wide">
			<div class="text-center mb-8">
				<h2 class="text-2xl font-bold text-white mb-2">Act 2: Explore the Data</h2>
				<p class="text-neutral-400">Analyze the charts to find the pattern.</p>
			</div>
			<CaseStudyChartsIsland
				client:visible
				sampleKey={sampleKey}
				tools={tools}
				height={350}
			/>
		</div>
	</section>

	<!-- Act 3: Guided Solution -->
	<section class="py-16 bg-white" id="solution-section">
		<div class="container-wide">
			<div class="max-w-3xl mx-auto">
				<ScrollReveal animation="fade-in">
					<h2 class="text-2xl font-bold mb-8 text-center">Act 3: The Reveal</h2>
				</ScrollReveal>

				<!-- Case steps display -->
				<CaseStepsDisplay
					client:load
					steps={steps}
				/>

				<!-- Key Insight -->
				<ScrollReveal animation="scale" delay={200}>
					<div class="mt-12 p-8 bg-neutral-900 text-white rounded-2xl text-center">
						<p class="text-sm font-medium text-neutral-400 uppercase tracking-wider mb-3">The Key Insight</p>
						<p class="text-2xl font-bold">{insight}</p>
					</div>
				</ScrollReveal>

				<!-- Related Tools -->
				<ScrollReveal animation="fade-up" delay={300}>
					<RelatedTools tools={tools} lang={lang} />
				</ScrollReveal>
			</div>
		</div>
	</section>

	<!-- CTA Section -->
	<section class="py-16 bg-neutral-50 border-t border-neutral-200" id="cta-section">
		<div class="container-wide">
			<div class="max-w-3xl mx-auto">
				<ScrollReveal animation="fade-up">
					<div class="text-center mb-8">
						<h2 class="text-3xl font-bold mb-4">What's hiding in YOUR data?</h2>
						<p class="text-neutral-600 mb-8">Try VaRiScout with your own data. Free, no signup required.</p>
						<div class="flex flex-col sm:flex-row gap-4 justify-center">
							<a href="/app" class="btn btn-primary px-8 py-3">Try Free</a>
							<a href={`/${lang}/journey`} class="btn btn-outline px-8 py-3">See the Full Journey</a>
						</div>
					</div>
				</ScrollReveal>

				<ScrollReveal animation="fade-up" delay={100}>
					<WhatsNext nextCase={nextCase} currentCase={sampleKey} lang={lang} />
				</ScrollReveal>
			</div>
		</div>
	</section>
</BaseLayout>
