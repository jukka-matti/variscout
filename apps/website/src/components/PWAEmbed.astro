---
import { ExternalLink, Maximize2 } from "lucide-astro";

interface Props {
	sampleKey: string;
	title?: string;
	height?: string;
	iframeId?: string;
	chart?: 'ichart' | 'boxplot' | 'pareto' | 'stats';
	tab?: 'summary' | 'histogram' | 'normality';
}

const {
	sampleKey,
	title = "Interactive Analysis",
	height = "600px",
	iframeId = `pwa-embed-${sampleKey}`,
	chart,
	tab,
} = Astro.props;

// Build the PWA URL with embed parameters
// Use direct PWA URL to avoid redirect issues with iframe query params
// PUBLIC_PWA_URL can be set in Vercel for preview/staging environments
const pwaBaseUrl = import.meta.env.PROD
  ? (import.meta.env.PUBLIC_PWA_URL || 'https://mean-beoynd-lite-pwa.vercel.app')
  : 'http://localhost:5173';

const chartParam = chart ? `&chart=${chart}` : '';
const tabParam = tab ? `&tab=${tab}` : '';
const pwaUrl = `${pwaBaseUrl}?sample=${sampleKey}&embed=true${chartParam}${tabParam}`;
const fullUrl = `${pwaBaseUrl}?sample=${sampleKey}${chartParam}${tabParam}`;
---

<div class="w-full bg-white border border-neutral-200 rounded-2xl overflow-hidden shadow-lg group pwa-embed-container" data-iframe-id={iframeId}>
	<div class="px-4 py-3 bg-neutral-50 border-b border-neutral-200 flex items-center justify-between">
		<div class="flex items-center gap-2">
			<div class="flex gap-1.5">
				<div class="w-3 h-3 rounded-full bg-neutral-300"></div>
				<div class="w-3 h-3 rounded-full bg-neutral-300"></div>
				<div class="w-3 h-3 rounded-full bg-neutral-300"></div>
			</div>
			<span class="ml-2 text-xs font-medium text-neutral-500 uppercase tracking-wider">{title}</span>
		</div>
		<div class="flex items-center gap-3">
			<a
				href={fullUrl}
				target="_blank"
				class="text-neutral-400 hover:text-brand-primary transition-colors p-1"
				title="Open in full app"
			>
				<ExternalLink size={16} />
			</a>
		</div>
	</div>

	<div class="relative overflow-hidden bg-neutral-900" style={`height: ${height}`}>
		<!-- Skeleton Loader -->
		<div class="pwa-skeleton absolute inset-0 flex items-center justify-center p-6" aria-hidden="true">
			<div class="w-full h-full flex gap-4">
				<!-- Left: Stats cards skeleton -->
				<div class="w-1/4 flex flex-col gap-3">
					<div class="h-20 bg-neutral-800 rounded-lg animate-pulse"></div>
					<div class="h-20 bg-neutral-800 rounded-lg animate-pulse" style="animation-delay: 100ms"></div>
					<div class="h-20 bg-neutral-800 rounded-lg animate-pulse" style="animation-delay: 200ms"></div>
					<div class="flex-1 bg-neutral-800 rounded-lg animate-pulse" style="animation-delay: 300ms"></div>
				</div>
				<!-- Right: Chart skeletons -->
				<div class="flex-1 flex flex-col gap-4">
					<div class="flex-1 bg-neutral-800 rounded-lg animate-pulse flex items-center justify-center">
						<svg class="w-12 h-12 text-neutral-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10M12 17V3m0 0l-4 4m4-4l4 4" transform="rotate(180 12 12)" />
						</svg>
					</div>
					<div class="flex-1 bg-neutral-800 rounded-lg animate-pulse flex items-center justify-center" style="animation-delay: 150ms">
						<svg class="w-12 h-12 text-neutral-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
						</svg>
					</div>
				</div>
			</div>
		</div>

		<!-- Iframe -->
		<iframe
			id={iframeId}
			src={pwaUrl}
			title={title}
			class="pwa-iframe absolute inset-0 w-full h-full border-none opacity-0 transition-opacity duration-300"
			loading="lazy"
			allow="clipboard-read; clipboard-write; fullscreen"
		></iframe>

		<!-- Overlay for mobile/instruction -->
		<div class="absolute inset-0 bg-neutral-900/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none md:hidden z-10">
			<span class="text-white text-sm font-medium px-4 py-2 border border-white/20 rounded-full backdrop-blur-md">
				Use on desktop for best experience
			</span>
		</div>
	</div>

	<div class="p-4 bg-white border-t border-neutral-200 flex items-center justify-between">
		<p class="text-xs text-neutral-500">
			Interactive preview. Click and drag in the charts to filter data.
		</p>
		<a href={fullUrl} class="text-xs font-semibold text-brand-primary hover:underline flex items-center gap-1">
			Go to Full App <Maximize2 size={12} />
		</a>
	</div>
</div>

<script>
	// Type guard for embed response messages
	function isEmbedResponse(data: unknown): data is { type: string; action: string } {
		if (typeof data !== 'object' || data === null) return false;
		const msg = data as Record<string, unknown>;
		return msg.type === 'variscout-embed-response' && typeof msg.action === 'string';
	}

	// Handle iframe ready state for all PWAEmbed instances
	function initPWAEmbed() {
		const containers = document.querySelectorAll<HTMLElement>('.pwa-embed-container');

		containers.forEach((container) => {
			const iframeId = container.dataset.iframeId;
			if (!iframeId) return;

			const iframe = document.getElementById(iframeId) as HTMLIFrameElement | null;
			const skeleton = container.querySelector('.pwa-skeleton') as HTMLElement | null;

			if (!iframe) return;

			// Handle ready message from PWA
			const handleMessage = (event: MessageEvent) => {
				if (!isEmbedResponse(event.data)) return;
				if (event.data.action === 'ready') {
					// Show iframe, hide skeleton
					iframe.classList.remove('opacity-0');
					iframe.classList.add('opacity-100');
					if (skeleton) {
						skeleton.style.opacity = '0';
						setTimeout(() => {
							skeleton.style.display = 'none';
						}, 300);
					}
				}
			};

			window.addEventListener('message', handleMessage);

			// Fallback: Show iframe after timeout even if no ready message
			setTimeout(() => {
				if (iframe.classList.contains('opacity-0')) {
					iframe.classList.remove('opacity-0');
					iframe.classList.add('opacity-100');
					if (skeleton) {
						skeleton.style.opacity = '0';
						setTimeout(() => {
							skeleton.style.display = 'none';
						}, 300);
					}
				}
			}, 5000);
		});
	}

	// Run on page load
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initPWAEmbed);
	} else {
		initPWAEmbed();
	}

	// Re-run on Astro page transitions (for View Transitions)
	document.addEventListener('astro:page-load', initPWAEmbed);
</script>
